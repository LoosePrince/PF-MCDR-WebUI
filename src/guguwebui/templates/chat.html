<!DOCTYPE html>
<html lang="zh-CN" class="h-full" x-data="{ darkMode: localStorage.getItem('darkMode') === 'true' }" :class="{ 'dark': darkMode }">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="page.chat.title"></title>
    <link rel="icon" type="image/x-icon" href="src/default_avatar.jpg">
    <script src="js/theme-preload.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="js/alpine.min.js" defer></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="custom/overall.css">
    <script defer src="js/i18n.js"></script>
    <script src="js/rtext-parser.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class'
        }
    </script>
    <style>
        /* 聊天消息气泡样式 */
        .chat-message {
            transition: all 0.3s ease;
        }
        /* 移除悬停位移动画，仅保留过渡用于其他效果 */
        
        /* 自己的消息样式 */
        .my-message {
            background: linear-gradient(135deg, #10b981, #059669);
            box-shadow: 0 10px 15px -5px rgba(16, 185, 129, 0.25), 0 4px 6px -4px rgba(16, 185, 129, 0.25);
            border-radius: 1rem;
        }
        
        .my-message:hover {
            background: linear-gradient(135deg, #059669, #047857);
        }
        
        /* 他人消息样式 */
        .other-message {
            background: linear-gradient(135deg, #f3f4f6, #e5e7eb);
            box-shadow: 0 10px 15px -5px rgba(0, 0, 0, 0.08), 0 4px 6px -4px rgba(0, 0, 0, 0.06);
            border-radius: 1rem;
            border: 1px solid rgba(0,0,0,0.05);
        }
        
        .dark .other-message {
            background: linear-gradient(135deg, #374151, #4b5563);
            border: 1px solid rgba(255,255,255,0.06);
        }
        
        /* RText样式 */
        .rtext-obfuscated {
            animation: obfuscate 0.5s infinite;
        }
        
        @keyframes obfuscate {
            0% { opacity: 1; }
            50% { opacity: 0.3; }
            100% { opacity: 1; }
        }
        
        /* RText点击元素样式 */
        .rtext-clickable {
            cursor: pointer;
            text-decoration: underline;
            text-decoration-style: dashed;
        }
        
        .rtext-clickable:hover {
            text-decoration-style: solid;
        }
        
        .other-message:hover {
            background: linear-gradient(135deg, #e5e7eb, #d1d5db);
        }
        
        .dark .other-message:hover {
            background: linear-gradient(135deg, #4b5563, #6b7280);
        }
        
        /* 消息容器滚动条样式 */
        .chat-messages-container::-webkit-scrollbar {
            width: 6px;
        }
        
        .chat-messages-container::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 3px;
        }
        
        .dark .chat-messages-container::-webkit-scrollbar-track {
            background: #1f2937;
        }
        
        .chat-messages-container::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }
        
        .dark .chat-messages-container::-webkit-scrollbar-thumb {
            background: #4b5563;
        }
        
        .chat-messages-container::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
        
        .dark .chat-messages-container::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }
        
        /* 登录卡片与动画背景，复用 login.html 视觉风格 */
        .card-hover {
            transition: all 0.3s ease;
        }
        .card-hover:hover {
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        .bg-animated {
            background: linear-gradient(45deg, #3b82f6, #8b5cf6, #06b6d4);
            background-size: 200% 200%;
            animation: gradient 15s ease infinite;
        }
        @keyframes gradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
    </style>
</head>
<body class="h-full bg-gradient-to-br from-gray-50 via-gray-100 to-gray-50 dark:from-gray-900 dark:via-gray-950 dark:to-gray-900">
    <div id="chatApp" x-data="chatApp()" class="min-h-full" x-init="$nextTick(()=>{})">
        <header class="sticky top-0 z-30 bg-white/80 dark:bg-gray-900/60 backdrop-blur supports-[backdrop-filter]:bg-white/60 dark:supports-[backdrop-filter]:bg-gray-900/40 border-b border-gray-200/70 dark:border-gray-800">
            <div class="max-w-7xl mx-auto px-3 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-16">
                    <div class="flex items-center">
                        <img src="src/default_avatar.jpg" alt="Logo" class="h-9 w-9 rounded-full shadow ring-1 ring-gray-200 dark:ring-gray-700 mr-3">
                        <h1 class="text-xl font-semibold tracking-tight text-gray-900 dark:text-white" data-i18n="page.chat.header_title"></h1>
                    </div>
                    <div class="flex items-center space-x-4">
                        <!-- 主题切换 -->
                        <button @click="darkMode = !darkMode; localStorage.setItem('darkMode', darkMode); applyTheme()" class="inline-flex items-center justify-center p-2 rounded-md text-gray-600 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-blue-500 transition">
                            <i class="fas" :class="darkMode ? 'fa-sun' : 'fa-moon'"></i>
                        </button>
                        <div x-show="isLoggedIn" class="flex items-center space-x-2">
                            <span class="hidden sm:inline text-sm text-gray-700 dark:text-gray-300"><span data-i18n="page.chat.player_label"></span><span class="font-medium" x-text="currentPlayer"></span></span>
                            <button @click="logout()" class="text-xs sm:text-sm text-red-600 hover:text-red-700 dark:text-red-400 dark:hover:text-red-300 px-2 py-1 rounded hover:bg-red-50 dark:hover:bg-red-900/20" data-i18n="nav.logout"></button>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <main class="max-w-7xl mx-auto px-3 sm:px-6 lg:px-8 py-6 sm:py-8">
            <!-- 全屏动画背景 -->
            <div class="fixed inset-0 bg-animated opacity-10 dark:bg-gray-900 -z-10 pointer-events-none"></div>
            <!-- 未登录视图：全屏背景 + 居中登录卡片（带左右切换） -->
            <div x-show="!isLoggedIn" class="relative z-0">
                
                <div class="relative mx-auto w-11/12 max-w-lg z-10">
                    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl backdrop-blur-sm p-6 sm:p-8 border border-gray-200 dark:border-gray-700" x-data="{ activeLoginTab: 'verify' }">
                        <!-- 顶部徽标 -->
                        <div class="flex justify-center mb-6">
                            <div class="relative">
                                <div class="w-16 h-16 rounded-full bg-gradient-to-r from-blue-400 to-purple-500 flex items-center justify-center mx-auto shadow-lg">
                                    <i class="fas fa-comments text-white text-2xl"></i>
                                </div>
                                <div class="absolute -right-1 bottom-2 bg-green-500 rounded-full w-4 h-4 border-2 border-white dark:border-gray-800 animate-ping opacity-75"></div>
                                <div class="absolute -right-1 bottom-2 bg-green-500 rounded-full w-4 h-4 border-2 border-white dark:border-gray-800"></div>
                            </div>
                        </div>

                        <h2 class="text-xl font-bold text-center text-gray-800 dark:text-white mb-2" data-i18n="app.name"></h2>
                        <p class="text-gray-500 dark:text-gray-400 text-center mb-6" data-i18n="page.chat.header_title"></p>

                        <!-- 顶部选项卡：验证码流程 / 直接登录 -->
                        <div class="flex mb-6 bg-gray-100 dark:bg-gray-700/30 rounded-lg p-1">
                            <button @click="activeLoginTab = 'verify'" :class="{'bg-white dark:bg-gray-800 text-blue-600 dark:text-blue-400 shadow': activeLoginTab === 'verify', 'text-gray-600 dark:text-gray-400': activeLoginTab !== 'verify'}" class="flex-1 py-2 rounded-md font-medium text-sm transition-all duration-300 ease-in-out"><span data-i18n="page.chat.tabs.verify_flow"></span></button>
                            <button @click="activeLoginTab = 'login'" :class="{'bg-white dark:bg-gray-800 text-blue-600 dark:text-blue-400 shadow': activeLoginTab === 'login', 'text-gray-600 dark:text-gray-400': activeLoginTab !== 'login'}" class="flex-1 py-2 rounded-md font-medium text-sm transition-all duration-300 ease-in-out"><span data-i18n="page.chat.tabs.direct_login"></span></button>
                        </div>

                        <!-- 胶囊形三段式步骤指示器（仅在验证码流程显示） -->
                        <div class="mb-6" x-show="activeLoginTab === 'verify'">
                            <div class="flex items-stretch h-10 rounded-full bg-gray-200 dark:bg-gray-700 overflow-hidden divide-x divide-white/30 dark:divide-black/20 shadow-inner">
                                <div class="flex-1 flex items-center justify-center text-xs sm:text-sm font-medium px-3 select-none" :class="currentStep >= 1 ? 'bg-blue-600 text-white' : 'text-gray-700 dark:text-gray-200'">
                                    <span>1.</span>
                                    <span class="ml-1" data-i18n="page.chat.steps.get_code"></span>
                                </div>
                                <div class="flex-1 flex items-center justify-center text-xs sm:text-sm font-medium px-3 select-none" :class="currentStep >= 2 ? 'bg-blue-600 text-white' : 'text-gray-700 dark:text-gray-200'">
                                    <span>2.</span>
                                    <span class="ml-1" data-i18n="page.chat.steps.verify_in_game"></span>
                                </div>
                                <div class="flex-1 flex items-center justify-center text-xs sm:text-sm font-medium px-3 select-none" :class="currentStep >= 3 ? 'bg-blue-600 text-white' : 'text-gray-700 dark:text-gray-200'">
                                    <span>3.</span>
                                    <span class="ml-1" data-i18n="page.chat.steps.set_password"></span>
                                </div>
                            </div>
                        </div>

                        <!-- 验证码三步流程（左右切换动效） -->
                        <div class="space-y-6" x-show="activeLoginTab === 'verify'"
                             x-transition:enter="transition ease-out duration-300"
                             x-transition:enter-start="opacity-0 transform translate-x-4"
                             x-transition:enter-end="opacity-100 transform translate-x-0"
                             x-transition:leave="transition ease-in duration-200"
                             x-transition:leave-start="opacity-100 transform translate-x-0"
                             x-transition:leave-end="opacity-0 transform -translate-x-4">
                            <!-- 步骤1: 获取验证码 -->
                            <div x-show="currentStep === 1" class="bg-white dark:bg-gray-800 rounded-lg p-0">
                                <h3 class="text-lg font-semibold mb-3 text-gray-800 dark:text-gray-200" data-i18n="page.chat.get_code.title"></h3>
                                <p class="text-gray-600 dark:text-gray-400 mb-5">
                                    <span data-i18n="page.chat.get_code.desc_before"></span>
                                    <code class="bg-gray-100 dark:bg-gray-700 px-2 py-1 rounded">!!webui verify &lt;code&gt;</code>
                                    <span data-i18n="page.chat.get_code.desc_after"></span>
                                </p>
                                <div class="text-center mb-5">
                                    <button @click="generateVerificationCode()" :disabled="isGenerating" class="px-6 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 dark:focus:ring-offset-gray-800 disabled:opacity-50 disabled:cursor-not-allowed">
                                        <i class="fas fa-key mr-2"></i>
                                        <span x-show="isGenerating" data-i18n="page.chat.get_code.loading"></span>
                                        <span x-show="!isGenerating" data-i18n="page.chat.get_code.generate"></span>
                                    </button>
                                </div>
                                <div x-show="verificationCode" class="text-center">
                                    <p class="text-sm text-gray-600 dark:text-gray-400 mb-2" data-i18n="page.chat.get_code.your_code"></p>
                                    <div class="text-3xl font-mono font-bold text-blue-600 mb-3" x-text="verificationCode"></div>
                                    <p class="text-xs text-gray-500 dark:text-gray-500" data-i18n="page.chat.get_code.hint_use_cmd"></p>
                                    <p class="text-xs text-red-500 mt-2" data-i18n="page.chat.get_code.expire_hint"></p>
                                </div>
                            </div>

                            <!-- 步骤2: 游戏内验证 -->
                            <div x-show="currentStep === 2" class="bg-white dark:bg-gray-800 rounded-lg p-0">
                                <h3 class="text-lg font-semibold mb-3 text-gray-800 dark:text-gray-200" data-i18n="page.chat.verify.title"></h3>
                                <p class="text-gray-600 dark:text-gray-400 mb-5" data-i18n="page.chat.verify.desc"></p>
                                <div class="bg-gray-100 dark:bg-gray-700 p-4 rounded-lg mb-5">
                                    <code class="text-lg font-mono text-blue-600 dark:text-blue-400">!!webui verify <span x-text="verificationCode"></span></code>
                                </div>
                                <p class="text-sm text-gray-600 dark:text-gray-400 mb-4" data-i18n="page.chat.verify.next_hint"></p>
                                <div class="flex justify-center space-x-4">
                                    <button @click="currentStep = 1" class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 dark:focus:ring-offset-gray-800">
                                        <i class="fas fa-arrow-left mr-2"></i><span data-i18n="common.back"></span>
                                    </button>
                                    <button @click="checkVerification()" :disabled="isChecking" class="px-6 py-3 bg-green-500 text-white rounded-lg hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 dark:focus:ring-offset-gray-800 disabled:opacity-50 disabled:cursor-not-allowed">
                                        <i class="fas fa-check mr-2"></i>
                                        <span x-show="isChecking" data-i18n="common.loading"></span>
                                        <span x-show="!isChecking" data-i18n="page.chat.verify.check"></span>
                                    </button>
                                </div>
                                <div x-show="verificationError" class="mt-4 p-3 bg-red-100 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg">
                                    <p class="text-sm text-red-800 dark:text-red-200" x-text="verificationError"></p>
                                </div>
                            </div>

                            <!-- 步骤3: 设置密码 -->
                            <div x-show="currentStep === 3" class="bg-white dark:bg-gray-800 rounded-lg p-0">
                                <h3 class="text-lg font-semibold mb-3 text-gray-800 dark:text-gray-200" data-i18n="page.chat.set_password.title"></h3>
                                <p class="text-gray-600 dark:text-gray-400 mb-5" data-i18n="page.chat.set_password.desc"></p>
                                <form @submit.prevent="setPassword()" class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2" data-i18n="page.chat.set_password.password_label"></label>
                                        <input type="password" x-model="newPassword" required minlength="6" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white" data-i18n-placeholder="page.chat.set_password.password_placeholder" placeholder="">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2" data-i18n="page.chat.set_password.confirm_label"></label>
                                        <input type="password" x-model="confirmPassword" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white" data-i18n-placeholder="page.chat.set_password.confirm_placeholder" placeholder="">
                                    </div>
                                    <div x-show="passwordError" class="p-3 bg-red-100 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg">
                                        <p class="text-sm text-red-800 dark:text-red-200" x-text="passwordError"></p>
                                    </div>
                                    <div class="flex justify-center space-x-4">
                                        <button type="button" @click="currentStep = 2" class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 dark:focus:ring-offset-gray-800">
                                            <i class="fas fa-arrow-left mr-2"></i><span data-i18n="common.back"></span>
                                        </button>
                                        <button type="submit" :disabled="isSettingPassword" class="px-6 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:focus:ring-offset-gray-800 disabled:opacity-50 disabled:cursor-not-allowed">
                                            <i class="fas fa-save mr-2"></i>
                                            <span x-show="isSettingPassword" data-i18n="page.chat.set_password.loading"></span>
                                            <span x-show="!isSettingPassword" data-i18n="page.chat.set_password.submit"></span>
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>

                        <!-- 登录表单（左右切换动效） -->
                        <div x-show="activeLoginTab === 'login'"
                             x-transition:enter="transition ease-out duration-300"
                             x-transition:enter-start="opacity-0 transform -translate-x-4"
                             x-transition:enter-end="opacity-100 transform translate-x-0"
                             x-transition:leave="transition ease-in duration-200"
                             x-transition:leave-start="opacity-100 transform translate-x-0"
                             x-transition:leave-end="opacity-0 transform translate-x-4">
                            <h3 class="text-lg font-semibold mb-3 text-gray-800 dark:text-gray-200" data-i18n="page.chat.login.title"></h3>
                            <p class="text-gray-600 dark:text-gray-400 mb-5" data-i18n="page.chat.login.desc"></p>
                            <form @submit.prevent="login()" class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2" data-i18n="page.chat.login.player_id_label"></label>
                                    <input type="text" x-model="loginPlayerId" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white" data-i18n-placeholder="page.chat.login.player_id_placeholder" placeholder="">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2" data-i18n="page.chat.login.password_label"></label>
                                    <input type="password" x-model="loginPassword" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white" data-i18n-placeholder="page.chat.login.password_placeholder" placeholder="">
                                </div>
                                <div x-show="loginError" class="p-3 bg-red-100 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg">
                                    <p class="text-sm text-red-800 dark:text-red-200" x-text="loginError"></p>
                                </div>
                                <div class="text-center">
                                    <button type="submit" :disabled="isLoggingIn" class="px-6 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 dark:focus:ring-offset-gray-800 disabled:opacity-50 disabled:cursor-not-allowed">
                                        <i class="fas fa-sign-in-alt mr-2"></i>
                                        <span x-show="isLoggingIn" data-i18n="page.chat.login.loading"></span>
                                        <span x-show="!isLoggingIn" data-i18n="page.chat.login.submit"></span>
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 聊天界面（统一卡片风格） -->
            <div x-show="isLoggedIn" class="relative mx-auto w-11/12 max-w-3xl">
                <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl backdrop-blur-sm border border-gray-200 dark:border-gray-700">
                    <!-- 手机端：两行顶栏 -->
                    <div class="px-4 pt-3 pb-3 border-b border-gray-200 dark:border-gray-700 md:hidden">
                        <div class="flex items-center justify-between">
                            <h2 class="text-base font-semibold text-gray-800 dark:text-gray-200" data-i18n="page.chat.room.title"></h2>
                            <div class="flex items-center space-x-2">
                                <button @click="toggleAvatarSource()" class="text-xs px-2 py-1 rounded-md border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">
                                    <span x-show="avatarSource === 'crafatar'" data-i18n="page.chat.avatar_source.crafatar"></span>
                                    <span x-show="avatarSource === 'mccag'" data-i18n="page.chat.avatar_source.mccag"></span>
                                </button>
                                <button @click="toggleMcStyleMode()" class="text-xs px-2 py-1 rounded-md border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">
                                    <span x-show="mcStyleMode" data-i18n="page.chat.mc_style.mc"></span>
                                    <span x-show="!mcStyleMode" data-i18n="page.chat.mc_style.standard"></span>
                                </button>
                            </div>
                        </div>
                        <div class="mt-2 flex items-center justify-between text-xs text-gray-500 dark:text-gray-400">
                            <div>
                                <span x-text="serverStatus"></span>
                                <span class="ml-2" x-text="serverVersion"></span>
                                <span class="ml-2" x-text="serverPlayers"></span>
                            </div>
                            <button @click="showOnlinePanel = true" class="inline-flex items-center justify-center w-8 h-8 rounded-md border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">
                                <i class="fas fa-users"></i>
                            </button>
                        </div>
                    </div>

                    <!-- 桌面端：单行顶栏 -->
                    <div class="hidden md:flex items-center justify-between px-6 pt-4 pb-4 border-b border-gray-200 dark:border-gray-700">
                        <div>
                            <h2 class="text-lg font-semibold text-gray-800 dark:text-gray-200" data-i18n="page.chat.room.title"></h2>
                            <p class="text-sm text-gray-600 dark:text-gray-400" data-i18n="page.chat.room.desc"></p>
                            <div class="mt-1 text-xs text-gray-500 dark:text-gray-400">
                                <span x-text="serverStatus"></span>
                                <span class="ml-2" x-text="serverVersion"></span>
                                <span class="ml-2" x-text="serverPlayers"></span>
                            </div>
                        </div>
                        <div class="flex items-center space-x-2">
                            <button @click="toggleAvatarSource()" class="text-xs px-2 py-1 rounded-md border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">
                                <span x-show="avatarSource === 'crafatar'" data-i18n="page.chat.avatar_source.crafatar"></span>
                                <span x-show="avatarSource === 'mccag'" data-i18n="page.chat.avatar_source.mccag"></span>
                            </button>
                            <button @click="toggleMcStyleMode()" class="text-xs px-2 py-1 rounded-md border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">
                                <span x-show="mcStyleMode" data-i18n="page.chat.mc_style.mc"></span>
                                <span x-show="!mcStyleMode" data-i18n="page.chat.mc_style.standard"></span>
                            </button>
                        </div>
                    </div>
                    
                    <div class="flex flex-col-reverse h-[calc(100vh-20rem)] overflow-y-auto p-6 bg-gray-50 dark:bg-gray-800 chat-messages-container">
                        
                        
                        <!-- 聊天消息列表 -->
                        <div x-show="chatMessages.length > 0" class="flex flex-col-reverse space-y-3">
                            <template x-for="message in chatMessages" :key="message.id">
                                <div class="w-full">
                                    <template x-if="!mcStyleMode">
                                        <div class="chat-message flex items-start space-x-3" :class="message.player_id === currentPlayer ? 'flex-row-reverse space-x-reverse' : ''">
                                            <div class="flex-shrink-0">
                                                <!-- 插件消息头像 -->
                                                <template x-if="message.is_plugin">
                                                    <div class="w-8 h-8 flex items-center justify-center text-white text-sm font-bold shadow-md ring-2 ring-white dark:ring-gray-800 bg-purple-500" x-text="(message.plugin_id || message.player_id).charAt(0).toUpperCase()"></div>
                                                </template>
                                                <!-- 玩家消息头像 -->
                                                <template x-if="!message.is_plugin">
                                                    <template x-if="message.uuid && avatarSource === 'crafatar'">
                                                        <img :src="`https://crafatar.com/avatars/${message.uuid}`" alt="avatar" class="w-8 h-8 object-cover shadow-md ring-2 ring-white dark:ring-gray-800">
                                                    </template>
                                                    <template x-if="avatarSource === 'mccag'">
                                                        <div class="w-8 h-8 overflow-hidden shadow-md ring-2 ring-white dark:ring-gray-800">
                                                            <img :src="`https://x.xzt.plus/api/generate/minimal/mojang/${message.player_id}`" alt="avatar" class="w-full h-full object-cover transform scale-150 origin-center">
                                                        </div>
                                                    </template>
                                                    <template x-if="!message.uuid && avatarSource === 'crafatar'">
                                                        <div class="w-8 h-8 flex items-center justify-center text-white text-sm font-bold shadow-md ring-2 ring-white dark:ring-gray-800 bg-blue-500" x-text="message.player_id.charAt(0).toUpperCase()"></div>
                                                    </template>
                                                </template>
                                            </div>
                                            <div class="flex-1 min-w-0" :class="message.player_id === currentPlayer ? 'text-right' : ''">
                                                <div class="flex items-center space-x-2 mb-1" :class="message.player_id === currentPlayer ? 'justify-end space-x-reverse' : ''">
                                                    <span class="font-medium text-gray-900 dark:text-white" x-text="message.is_plugin ? (message.plugin_id || message.player_id) : message.player_id"></span>
                                                    <span class="text-xs px-2 py-0.5 rounded-full bg-gray-100 dark:bg-gray-700/60 text-gray-600 dark:text-gray-300 shadow-sm" x-text="formatTimestamp(message.timestamp)"></span>
                                                </div>
                                                <div class="text-sm break-words px-3 py-2 rounded-xl shadow-sm inline-block align-top max-w-[80%]" :class="message.player_id === currentPlayer ? 'ml-auto bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-200 border border-gray-200 dark:border-gray-700' : 'bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-200 border border-gray-200 dark:border-gray-700'" x-html="renderMessage(message)"></div>
                                            </div>
                                        </div>
                                    </template>
                                    <template x-if="mcStyleMode">
                                        <div class="flex items-center space-x-2 text-sm text-gray-900 dark:text-gray-100">
                                            <div class="flex-shrink-0">
                                                <!-- 插件消息头像 -->
                                                <template x-if="message.is_plugin">
                                                    <div class="w-5 h-5 flex items-center justify-center bg-purple-500 text-white text-[10px] font-bold" x-text="(message.plugin_id || message.player_id).charAt(0).toUpperCase()"></div>
                                                </template>
                                                <!-- 玩家消息头像 (WebUI和游戏消息) -->
                                                <template x-if="!message.is_plugin">
                                                    <template x-if="message.uuid && avatarSource === 'crafatar'">
                                                        <img :src="`https://crafatar.com/avatars/${message.uuid}`" alt="avatar" class="w-5 h-5 object-cover">
                                                    </template>
                                                    <template x-if="avatarSource === 'mccag'">
                                                        <div class="w-5 h-5 overflow-hidden">
                                                            <img :src="`https://x.xzt.plus/api/generate/minimal/mojang/${message.player_id}`" alt="avatar" class="w-full h-full object-cover transform scale-150 origin-center">
                                                        </div>
                                                    </template>
                                                    <template x-if="!message.uuid && avatarSource === 'crafatar'">
                                                        <div class="w-5 h-5 flex items-center justify-center bg-blue-500 text-white text-[10px] font-bold" x-text="message.player_id.charAt(0).toUpperCase()"></div>
                                                    </template>
                                                </template>
                                            </div>
                                            <span class="text-xs text-gray-500 dark:text-gray-300" x-text="formatTimeOnly(message.timestamp)"></span>
                                            <span class="text-gray-800 dark:text-gray-100">&lt;<span x-text="message.is_plugin ? (message.plugin_id || message.player_id) : message.player_id"></span>&gt;</span>
                                            <span class="text-gray-900 dark:text-gray-100 break-words" x-html="renderMessage(message)"></span>
                                        </div>
                                    </template>
                                </div>
                            </template>
                        </div>
                        
                        <!-- 空状态 -->
                        <div x-show="chatMessages.length === 0 && !isLoadingMessages" class="text-center text-gray-500 dark:text-gray-400 py-12">
                            <i class="fas fa-comments text-6xl mb-4 opacity-50"></i>
                            <p class="text-lg font-medium" data-i18n="page.chat.room.empty.title"></p>
                            <p class="text-sm mt-2" data-i18n="page.chat.room.empty.hint"></p>
                        </div>

                        <!-- 加载更多按钮 -->
                        <div x-show="hasMoreMessages" class="text-center mb-4">
                            <button @click="loadMoreMessages()" :disabled="isLoadingMessages" class="px-4 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 dark:focus:ring-offset-gray-800 disabled:opacity-50">
                                <span x-show="isLoadingMessages" data-i18n="common.loading"></span>
                                <span x-show="!isLoadingMessages" data-i18n="page.chat.room.load_more"></span>
                            </button>
                        </div>
                        
                        <!-- 加载状态 -->
                        <div x-show="isLoadingMessages" class="text-center text-gray-500 dark:text-gray-400 py-12">
                            <i class="fas fa-spinner fa-spin text-4xl mb-4"></i>
                            <p class="text-lg font-medium" data-i18n="page.chat.room.loading.title"></p>
                            <p class="text-sm mt-2" data-i18n="page.chat.room.loading.hint"></p>
                        </div>
                    </div>
                    
                    <div class="px-6 py-4 border-t border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800 rounded-b-2xl">
                        <div class="flex flex-col sm:flex-row sm:space-x-3 space-y-2 sm:space-y-0">
                            <input type="text" x-model="chatMessage" class="flex-1 min-w-0 w-full px-3 py-2 sm:px-4 sm:py-3 border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white transition-all duration-200" @keyup.enter="sendMessage()" data-i18n-placeholder="page.chat.room.input.placeholder" placeholder="">
                            <button @click="sendMessage()" :disabled="!chatMessage.trim() || isSending" class="w-full sm:w-auto px-4 py-2 text-sm sm:text-base sm:px-6 sm:py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 dark:focus:ring-offset-gray-800 disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-200 flex items-center justify-center space-x-2">
                                <i class="fas fa-paper-plane"></i>
                                <span class="hidden sm:inline" x-show="isSending" data-i18n="page.chat.room.send.loading"></span>
                                <span class="hidden sm:inline" x-show="!isSending" data-i18n="page.chat.room.send.submit"></span>
                            </button>
                        </div>
                        <div class="mt-2 text-xs text-gray-500 dark:text-gray-400 text-center">
                            <i class="fas fa-info-circle mr-1"></i>
                            <span data-i18n="page.chat.room.input.hint"></span>
                        </div>
                    </div>
                </div>
            </div>
        <!-- 桌面端右侧在线列表（置于chatApp作用域内） -->
        <div x-show="isLoggedIn" x-cloak class="hidden md:block fixed right-4 top-24 w-64 bg-white dark:bg-gray-800 rounded-xl shadow-lg border border-gray-200 dark:border-gray-700 p-4 z-20">
            <h3 class="text-sm font-semibold text-gray-800 dark:text-gray-200 mb-2" data-i18n="page.index.online_players"></h3>
            <div class="space-y-2 max-h-80 overflow-y-auto">
                <template x-for="[name, info] in getAllMembers()" :key="name">
                    <div class="flex items-center justify-between text-sm" :class="info.status === 'offline' || info.status === 'bot' ? 'text-gray-400 dark:text-gray-500' : 'text-gray-700 dark:text-gray-300'">
                        <div class="flex-1 min-w-0">
                            <div class="truncate" x-text="name"></div>
                            <div x-show="info.status === 'offline' || info.status === 'bot'" class="text-xs text-gray-400 dark:text-gray-500" x-text="formatOfflineTime(info.lastSeen)"></div>
                        </div>
                        <span class="flex-shrink-0 ml-2">
                            <i class="fas fa-gamepad mr-1 text-green-500" x-show="info.status === 'game' || info.status === 'both' || info.status === 'game_bot' || info.status === 'all'"></i>
                            <i class="fas fa-globe text-blue-500" x-show="info.status === 'web' || info.status === 'both' || info.status === 'web_bot' || info.status === 'all'"></i>
                            <i class="fas fa-robot text-purple-500" x-show="info.status === 'bot' || info.status === 'web_bot' || info.status === 'game_bot' || info.status === 'all'"></i>
                            <i class="fas fa-user-slash text-gray-400" x-show="info.status === 'offline' && info.status !== 'bot'"></i>
                        </span>
                    </div>
                </template>
                <div x-show="getAllMembers().length === 0" class="text-xs text-gray-500 dark:text-gray-400" data-i18n="page.chat.room.empty.title"></div>
            </div>
        </div>

        <!-- 移动端抽屉在线列表（置于chatApp作用域内） -->
        <div x-show="showOnlinePanel" x-cloak class="md:hidden fixed inset-0 z-40" aria-modal="true">
            <div class="absolute inset-0 bg-black/30" @click="showOnlinePanel = false"></div>
            <div class="absolute right-0 top-0 bottom-0 w-60 bg-white dark:bg-gray-800 shadow-xl p-4 border-l border-gray-200 dark:border-gray-700">
                <div class="flex items-center justify-between mb-2">
                    <h3 class="text-sm font-semibold text-gray-800 dark:text-gray-200" data-i18n="page.index.online_players"></h3>
                    <button @click="showOnlinePanel = false" class="text-gray-600 dark:text-gray-300"><i class="fas fa-times"></i></button>
                </div>
                <div class="space-y-2 max-h-[80vh] overflow-y-auto">
                    <template x-for="[name, info] in getAllMembers()" :key="name">
                        <div class="flex items-center justify-between text-sm" :class="info.status === 'offline' || info.status === 'bot' ? 'text-gray-400 dark:text-gray-500' : 'text-gray-700 dark:text-gray-300'">
                            <div class="flex-1 min-w-0">
                                <div class="truncate" x-text="name"></div>
                                <div x-show="info.status === 'offline' || info.status === 'bot'" class="text-xs text-gray-400 dark:text-gray-500" x-text="formatOfflineTime(info.lastSeen)"></div>
                            </div>
                            <span class="flex-shrink-0 ml-2">
                                <i class="fas fa-gamepad mr-1 text-green-500" x-show="info.status === 'game' || info.status === 'both' || info.status === 'game_bot' || info.status === 'all'"></i>
                                <i class="fas fa-globe text-blue-500" x-show="info.status === 'web' || info.status === 'both' || info.status === 'web_bot' || info.status === 'all'"></i>
                                <i class="fas fa-robot text-purple-500" x-show="info.status === 'bot' || info.status === 'web_bot' || info.status === 'game_bot' || info.status === 'all'"></i>
                                <i class="fas fa-user-slash text-gray-400" x-show="info.status === 'offline' && info.status !== 'bot'"></i>
                            </span>
                        </div>
                    </template>
                    <div x-show="getAllMembers().length === 0" class="text-xs text-gray-500 dark:text-gray-400" data-i18n="page.chat.room.empty.title"></div>
                </div>
            </div>
        </div>

        </main>
    </div>

    <script src="custom/overall.js"></script>
    <script src="js/chat.js"></script>

    <!-- ICP备案信息 -->
    <div id="icp-records" class="fixed bottom-2 right-2 text-xs text-gray-500 dark:text-gray-400 hidden z-50">
        <div class="bg-white dark:bg-gray-800 px-2 py-1 rounded shadow-sm border border-gray-200 dark:border-gray-600">
            <!-- 备案信息将通过JavaScript动态添加 -->
        </div>
    </div>

    <script>
        // 加载ICP备案信息
        document.addEventListener('DOMContentLoaded', function() {
            fetch('api/config/icp-records')
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success' && data.icp_records && data.icp_records.length > 0) {
                        displayIcpRecords(data.icp_records);
                    }
                })
                .catch(error => {
                    console.error('Failed to load ICP records:', error);
                });
        });

        function displayIcpRecords(records) {
            const container = document.getElementById('icp-records');
            if (!container || records.length === 0) return;

            const recordsDiv = container.querySelector('div');
            recordsDiv.innerHTML = '';

            records.forEach(record => {
                const link = document.createElement('a');
                link.href = record.url;
                link.target = '_blank';
                link.rel = 'noopener noreferrer';
                link.className = 'text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200 transition-colors mr-2 last:mr-0';
                link.textContent = record.icp;
                recordsDiv.appendChild(link);
            });

            container.classList.remove('hidden');
        }
    </script>
</body>
</html>
