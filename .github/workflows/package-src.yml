name: Package src on Change

on:
  push:
    paths:
      - src/**
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: src/guguwebui/frontend/package-lock.json

    - name: Install frontend dependencies
      working-directory: src/guguwebui/frontend
      run: npm ci

    - name: Build frontend
      working-directory: src/guguwebui/frontend
      run: npm run build

    - name: Verify frontend build
      run: |
        if [ ! -d "src/guguwebui/static" ]; then
          echo "Error: Frontend build output not found at src/guguwebui/static"
          exit 1
        fi
        if [ ! -f "src/guguwebui/static/index.html" ]; then
          echo "Error: Frontend index.html not found"
          exit 1
        fi
        echo "‚úì Frontend build verified"

    - name: Package src directory
      run: |
        cd src
        # ÊéíÈô§ÊóßÁâàÂâçÁ´ØËµÑÊ∫ê‰∏é‰ª£Á†ÅÔºå‰ªÖÊâìÂåÖÊûÑÂª∫‰∫ßÁâ©‰∏éÂêéÁ´Ø
        zip -r ../guguweb_beta.mcdr . \
          -x "guguwebui/css*" \
          -x "guguwebui/custom*" \
          -x "guguwebui/frontend*" \
          -x "guguwebui/js*" \
          -x "guguwebui/lang*" \
          -x "guguwebui/src*" \
          -x "guguwebui/templates*"
        cd ..
        echo "Packaged src contents into guguweb_beta.mcdr (old frontend dirs excluded)"
        mkdir -p build
        cp guguweb_beta.mcdr build/
        echo "Copied guguweb_beta.mcdr to build directory"

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: guguweb_beta.mcdr
        path: guguweb_beta.mcdr

  release:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    permissions:
      contents: write
      packages: write
    env:
      GH_TOKEN: ${{ github.token }}
   
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Download artifact
      uses: actions/download-artifact@v4
      with:
        name: guguweb_beta.mcdr
        path: .

    - name: Determine release type from commit message
      id: release_meta
      run: |
        COMMIT_MESSAGE="${{ github.event.head_commit.message }}"
        TITLE=$(printf "%s\n" "$COMMIT_MESSAGE" | head -n 1 | tr -d '\r')
        BODY=$(printf "%s\n" "$COMMIT_MESSAGE" | tail -n +2 | sed 's/\r$//')
        TYPE="beta"
        VERSION_FROM_TITLE=""

        if [[ "$TITLE" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
          TYPE="formal"
          VERSION_FROM_TITLE="${TITLE#v}"
        fi

        echo "type=$TYPE" >> "$GITHUB_OUTPUT"
        echo "title=$TITLE" >> "$GITHUB_OUTPUT"

        echo "body<<EOF" >> "$GITHUB_OUTPUT"
        printf "%s\n" "$BODY" >> "$GITHUB_OUTPUT"
        echo "EOF" >> "$GITHUB_OUTPUT"

        echo "version_from_title=$VERSION_FROM_TITLE" >> "$GITHUB_OUTPUT"

    - name: Generate tag
      id: tag
      run: |
        # ‰ªémcdreforged.plugin.jsonËØªÂèñÁâàÊú¨Âè∑
        echo "Reading version from mcdreforged.plugin.json..."
        VERSION=$(cat src/mcdreforged.plugin.json | jq -r '.version')
        if [ -z "$VERSION" ] || [ "$VERSION" = "null" ]; then
          echo "Error: Failed to read version from mcdreforged.plugin.json"
          exit 1
        fi
        echo "Current plugin version: $VERSION"

        RELEASE_TYPE="${{ steps.release_meta.outputs.type }}"
        VERSION_FROM_TITLE="${{ steps.release_meta.outputs.version_from_title }}"

        if [ "$RELEASE_TYPE" = "formal" ]; then
          if [ -z "$VERSION_FROM_TITLE" ]; then
            echo "Error: Formal release detected but version_from_title is empty"
            exit 1
          fi
          if [ "$VERSION" != "$VERSION_FROM_TITLE" ]; then
            echo "Error: Version mismatch between mcdreforged.plugin.json ($VERSION) and commit title (v$VERSION_FROM_TITLE)"
            exit 1
          fi
          TAG="v${VERSION}"
          echo "Generating formal release tag: ${TAG}"
        else
          # ÁîüÊàêÊó∂Èó¥Êà≥Ê†áÁ≠æÔºåÊ†ºÂºèÔºöv{version}-beta.$(date +%Y%m%d-%H%M%S)
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          TAG="v${VERSION}-beta.${TIMESTAMP}"
          echo "Generating beta pre-release tag: ${TAG}"

          # È™åËØÅÊ†áÁ≠æÊ†ºÂºèÔºà‰ªÖÂØπ beta ÁîüÊïàÔºâ
          if [[ ! $TAG =~ ^v[0-9]+\.[0-9]+\.[0-9]+-beta\.[0-9]{8}-[0-9]{6}$ ]]; then
            echo "Error: Invalid tag format generated: $TAG"
            echo "Expected format: vX.Y.Z-beta.YYYYMMDD-HHMMSS"
            echo "Actual tag: $TAG"
            exit 1
          fi
        fi

        echo "tag=${TAG}" >> "$GITHUB_OUTPUT"
        echo "version=${VERSION}" >> "$GITHUB_OUTPUT"

        # Ê£ÄÊü•ÊòØÂê¶‰∏éÁé∞ÊúâÊ†áÁ≠æÂÜ≤Á™Å
        echo "Checking for tag conflicts..."
        if gh api repos/${{ github.repository }}/git/refs/tags/$TAG >/dev/null 2>&1; then
          echo "Error: Tag $TAG already exists!"
          exit 1
        fi

        echo "‚úì Tag $TAG is available"

    - name: Delete existing pre-releases
      run: |
        echo "=========================================="
        echo "üîç Pre-release Management Strategy"
        echo "=========================================="
        echo "Will DELETE: Beta versions (vX.Y.Z-beta.*, vX.Y.Z-rc.*, etc.)"
        echo "Will PRESERVE: Formal versions (v1.0.0, v2.1.3, etc.)"
        echo "Will PRESERVE: Notice versions (vX.Y.Z-notice.*, etc.)"
        echo "=========================================="
        
        # Ëé∑ÂèñÊâÄÊúâpre-releaseÔºå‰ΩÜÊéíÈô§Ê≠£ÂºèÁöÑvx.x.xÁâàÊú¨ÂíånoticeÁâàÊú¨
        RELEASES=$(gh api repos/${{ github.repository }}/releases --jq '.[] | select(.prerelease==true and (.tag_name | test("^v[0-9]+\\.[0-9]+\\.[0-9]+$") | not) and (.tag_name | test("-notice\\.") | not)) | .id' 2>/dev/null || echo "")
        
        if [ ! -z "$RELEASES" ]; then
          echo "Found existing beta pre-releases, deleting them..."
          for RELEASE_ID in $RELEASES; do
            # Ëé∑ÂèñreleaseÁöÑËØ¶ÁªÜ‰ø°ÊÅØ‰ª•ÊòæÁ§∫tag_name
            TAG_NAME=$(gh api repos/${{ github.repository }}/releases/$RELEASE_ID --jq '.tag_name' 2>/dev/null || echo "unknown")
            echo "Deleting beta pre-release ID: $RELEASE_ID (Tag: $TAG_NAME)"
            if gh api repos/${{ github.repository }}/releases/$RELEASE_ID -X DELETE; then
              echo "‚úì Successfully deleted beta pre-release: $TAG_NAME"
            else
              echo "‚ö† Failed to delete beta pre-release: $TAG_NAME"
            fi
          done
        else
          echo "No existing beta pre-releases found"
        fi
        
        # ÊòæÁ§∫‰øùÁïôÁöÑÊ≠£ÂºèÁâàÊú¨
        FORMAL_RELEASES=$(gh api repos/${{ github.repository }}/releases --jq '.[] | select(.prerelease==true and (.tag_name | test("^v[0-9]+\\.[0-9]+\\.[0-9]+$"))) | .tag_name' 2>/dev/null || echo "")
        if [ ! -z "$FORMAL_RELEASES" ]; then
          echo "Preserving formal pre-releases: $FORMAL_RELEASES"
        fi
        
        # ÊòæÁ§∫‰øùÁïôÁöÑnoticeÁâàÊú¨
        NOTICE_RELEASES=$(gh api repos/${{ github.repository }}/releases --jq '.[] | select(.prerelease==true and (.tag_name | test("-notice\\."))) | .tag_name' 2>/dev/null || echo "")
        if [ ! -z "$NOTICE_RELEASES" ]; then
          echo "Preserving notice pre-releases: $NOTICE_RELEASES"
        fi
        
        echo "=========================================="

    - name: Delete beta tags for formal release
      run: |
        RELEASE_TYPE="${{ steps.release_meta.outputs.type }}"
        if [ "$RELEASE_TYPE" != "formal" ]; then
          echo "Not a formal release, skip deleting beta tags."
          exit 0
        fi

        echo "Searching for beta tags (vX.Y.Z-beta.*) to delete..."
        BETA_TAG_REFS=$(gh api repos/${{ github.repository }}/git/refs/tags --paginate --jq '.[] | select(.ref | test("refs/tags/v[0-9]+\\.[0-9]+\\.[0-9]+-beta\\.")) | .ref' 2>/dev/null || echo "")

        if [ -z "$BETA_TAG_REFS" ]; then
          echo "No beta tags found."
        else
          for REF in $BETA_TAG_REFS; do
            TAG_NAME=${REF#"refs/tags/"}
            echo "Deleting beta tag: $TAG_NAME"
            if gh api repos/${{ github.repository }}/git/refs/tags/$TAG_NAME -X DELETE; then
              echo "‚úì Successfully deleted beta tag: $TAG_NAME"
            else
              echo "‚ö† Failed to delete beta tag: $TAG_NAME"
            fi
          done
        fi

    - name: Create release
      run: |
        RELEASE_TYPE="${{ steps.release_meta.outputs.type }}"
        TAG="${{ steps.tag.outputs.tag }}"
        VERSION="${{ steps.tag.outputs.version }}"

        echo "Creating ${RELEASE_TYPE} release: ${TAG}"
        
        # Ê£ÄÊü•MCDRÊñá‰ª∂ÊòØÂê¶Â≠òÂú®ÔºàÊûÑÂª∫‰∫ßÁâ©Ôºâ
        if [ ! -f "guguweb_beta.mcdr" ]; then
          echo "Error: guguweb_beta.mcdr file not found!"
          exit 1
        fi
        
        # Ëé∑ÂèñÂéüÂßãÊñá‰ª∂Â§ßÂ∞è
        FILE_SIZE=$(stat -c%s "guguweb_beta.mcdr" 2>/dev/null || stat -f%z "guguweb_beta.mcdr" 2>/dev/null || echo "unknown")
        echo "Original file size: ${FILE_SIZE} bytes"

        if [ "$RELEASE_TYPE" = "formal" ]; then
          # Ê≠£ÂºèÁâàÔºöÈáçÂëΩÂêç‰∏∫ guguweb_v1.x.x.mcdrÔºåÂπ∂‰ΩøÁî®Êèê‰∫§‰ø°ÊÅØÁ¨¨‰∫åË°åÂèä‰πãÂêé‰Ωú‰∏∫ËØ¥Êòé
          ASSET_NAME="guguweb_v${VERSION}.mcdr"
          cp guguweb_beta.mcdr "$ASSET_NAME"

          FILE_SIZE=$(stat -c%s "$ASSET_NAME" 2>/dev/null || stat -f%z "$ASSET_NAME" 2>/dev/null || echo "unknown")
          echo "Formal release asset: ${ASSET_NAME} (${FILE_SIZE} bytes)"

          NOTES_FILE="release_notes.md"
          # ‰ΩøÁî®Êèê‰∫§‰ø°ÊÅØÁ¨¨‰∫åË°åÂèä‰πãÂêé‰Ωú‰∏∫ËØ¥ÊòéÔºàÂèØÂ§öË°åÔºâ
          printf '%s\n' "${{ steps.release_meta.outputs.body }}" > "$NOTES_FILE"

          if gh release create "$TAG" \
            --title "v${VERSION}" \
            --notes-file "$NOTES_FILE" \
            --target ${{ github.sha }} \
            "$ASSET_NAME"; then
            
            echo "‚úì Successfully created formal release: $TAG"
            echo "Release URL: https://github.com/${{ github.repository }}/releases/tag/${TAG}"
          else
            echo "‚ùå Failed to create formal release"
            exit 1
          fi
        else
          # Beta ÁâàÔºö‰øùÊåÅÂéüÊúâÊñá‰ª∂ÂêçÂíåËá™Âä®ËØ¥Êòé
          ASSET_NAME="guguweb_beta.mcdr"
          NOTES_FILE="beta_notes.md"
          BUILD_TIME=$(date -u)

          {
            echo "Automated beta build from source changes"
            echo
            echo "**Build Info:**"
            echo "- Commit: ${{ github.sha }}"
            echo "- Branch: ${{ github.ref_name }}"
            echo "- Build Time: ${BUILD_TIME}"
            echo "- Triggered by: ${{ github.actor }}"
            echo "- File Size: ${FILE_SIZE} bytes"
            echo
            echo "**Installation:**"
            echo "Download the \`${ASSET_NAME}\` file and place it in your MCDR plugins directory."
            echo
            echo "**Changes:**"
            echo "This is an automated build triggered by changes in the \`src/\` directory."
          } > "$NOTES_FILE"

          if gh release create "$TAG" \
            --title "Beta Build v${VERSION} - ${TAG}" \
            --notes-file "$NOTES_FILE" \
            --prerelease \
            --target ${{ github.sha }} \
            "$ASSET_NAME"; then
            
            echo "‚úì Successfully created beta pre-release: $TAG"
            echo "Release URL: https://github.com/${{ github.repository }}/releases/tag/${TAG}"
          else
            echo "‚ùå Failed to create beta pre-release"
            exit 1
          fi
        fi

    - name: Clean up
      run: |
        # Ê∏ÖÁêÜÊú¨Âú∞Êñá‰ª∂
        rm -f guguweb_beta.mcdr
        echo "Cleanup completed"

    - name: Summary
      run: |
        echo "=========================================="
        echo "üéâ Pre-release creation completed!"
        echo "=========================================="
        echo "Tag: ${{ steps.tag.outputs.tag }}"
        echo "Repository: ${{ github.repository }}"
        echo "Commit: ${{ github.sha }}"
        echo "Branch: ${{ github.ref_name }}"
        echo "Actor: ${{ github.actor }}"
        echo "Release URL: https://github.com/${{ github.repository }}/releases/tag/${{ steps.tag.outputs.tag }}"
        echo "=========================================="
